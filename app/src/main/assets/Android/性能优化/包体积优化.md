
宗旨：删！删不了就尽量小

包体积优化几乎是每位移动开发都会碰到的问题，主要处于以下几个原因考虑：

- 下载转换率
  - 根据 Google Play 的报告显示，平均每增加 1M，转化率下降0.17%
  - 华为应用市场流量保护是 40M，超过 40M 的会弹出流量保护弹窗
- 性能影响
  - 包越大，安装时间越长，尤其是 5.0、6.0 art 虚拟机的 AOT 编译
  - 运行时 res、lib、dex 会加载到内存，体积越大可用内存越少

基于以上，包体积优化是非做不可，大致的流程是

1、确定优化的目标

哪些部分还可以再精简，比如代码可以怎么优化

再比如原先打包进 apk 文件的字体资源、H5离线包、图片、so等一些资源类的文件，能不能改为后台下发？

改为下发以后，接着是资源文件的加密解密工作，怎么防 root 用户直接读取应用目录，怎么防反编译拿到密钥等等

一定要打包发布的资源，能否再优化？

- 图片资源优化，压缩
- assets 资源优化
- sdk 去重和压缩，所有的三方库，包括 jetpack 组件库，全部抽到统一模块管理

最后实在不行，只能祭出插件化这个大杀器了。不过我的项目没用到过，暂时不管

2、监控与预警

成果：我个人负责的某项目从 70MB+ 下降到 50MB+ ，瘦身率达到 25% 左右

有了阶段性成果以后，接下来是怎么保持包体积的健康度

我们通常使用腾讯的 Matrix APK Checker 查看每次发版 apk 的各个目录的详细数据

记录下和上次版本的区别，哪些目录体积多了，哪些少了

下面直接开始介绍几个常见的方案

## 代码优化

### 1、代码混淆

Android 默认配置了 Proguard 混淆

每次引入三方库，记得在 proguard-rules.pro 文件配置即可

### 2、剔除无用/重复代码

随着业务不断迭代，有些功能可能实际是没用到的，这部分页面占用的资源可以被释放掉

- 利用 github 开源库 dependency-analysis-android-gradle-plugin 剔除无用或重复的SDK
- 利用 AS 的 Refactor -> Remove Unused Resources 删除无用资源

另外，关于三方库的使用，包括 jetpack 组件库，全部抽到统一模块管理

### 3、避免使用枚举

项目开发中，建议使用注解的方式来替代枚举类

每减少一个 ENUM 可减少大约 1.0 到 1.4 KB的大小

### 4、减少模板代码

因为历史包袱问题，Databinding、ViewBinding、ButterKnife 自动生成模板代码

导致增大了class 代码体量，因此，Apk变得更大

项目中要尽量避免使用类似依赖注入框架

### 5、DEX 优化

Facebook 在15年发布的 ReDex 开源库支持：

- DEX 文件瘦身
- 分包优化，互相引用的类尽量放在同个 Dex

这个我没用过，先不用管

## so优化

除了配置 abiFilters ，我们还可以压缩/混淆 so 文件，还可以动态下发 so，但这些我没做过，暂时不管

### 1、配置 abiFilters

```
defaultConfig {
    ndk {
        abiFilters "armeabi-v7a", "x86", 'arm64-v8a', 'x86_64'
    }
}
```

- 微信适配的是 arm64-v8a(微信应该是最近才适配到arm64-v8a,以前是armeabi)
- 支付宝和手Q适配的是 armeabi
- 淘宝适配的是 armeabi-v7a

不需要跑在虚拟机环境的话 X86 就不用管了，我负责的几个项目都是 armeabi-v7a

## 资源优化

### 1、图片压缩

- 使用 tinypng 压缩
- 对于闪屏，背景图等不带透明度的png图片，统统转成有损的jpg

这可能是最容易想到，也是大家都会做的方案，有一点需要注意：AAPT 工具默认使用内置的压缩算法来优化 res/drawable/ 目录下的 PNG 图片

如果使用 tinypng 二次压缩，那么可能会导致本来已经优化过的图片体积变大

为了避免以上情况方式，我们需要禁用默认压缩：

```
aaptOptions {
    cruncherEnabled = false
}
```

### 2、Tint着色器

API 21 开始，Android SDK 引入Tint着色器，Tint着色器就可以随意改变安卓项目中图标或者 View 背景的颜色

我们可以利用它，解决同一个样式，不同颜色的的场景。从而起到 Apk 瘦身的作用

### 3、Assets/Raw资源优化

- 尽量避免使用帧动画
- 项目中的语音播报文件wav、mp3和aac格式可以进行压缩优化 ，降低采样率
- 项目中可能为了某些特殊需求需要用到一些特殊的字体，但应用场景很少，我们可以考虑精简字体包

## 分析 apk

AS 自带 apk 分析工具，拖进去即可。一个正常 apk 文件包含：

- 根目录，dex 文件，项目代码
- lib 目录，保存各个架构下的动态链接库
- res 目录，保存图片、xml、string 等资源文件
- assets 目录，保存音频、html等资源文件
- META-INF 目录，保存 CERT.SF 和 CERT.RSA 等签名文件
- resources.arsc，保存 res 的配置文件

打包工具都在 sdk 目录下的 build-tools 中

apk的 构建过程和安装过程，可以参见《项目构建》目录下的 "APK打包流程" 以及 "APK安装流程.md"

## 参考资料

- [【保姆级】包体积优化教程 - 叶超](https://juejin.cn/post/7116089040264232967)
- [实战论 · 怎么做包体优化? - 小木箱](https://juejin.cn/post/7179230851853451323)
- [5年磨一剑｜优酷Android包瘦身治理思路全解](https://developer.aliyun.com/article/953463)