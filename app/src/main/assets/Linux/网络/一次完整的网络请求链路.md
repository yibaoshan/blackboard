
## DHCP

在我们的日常生活中，绝大多数的 IP 地址分配都是由路由器自动完成，也就是所谓的 DECP 模式

DHCP 全称 Dynamic Host Configuration Protocol，是计算机网络中一种动态主机配置协议

说白了，就是个管 IP 分配的服务器，其大致的工作流程如下：

### 1、DHCP Discover

终端设备（手机、电脑等）在刚连接上 WiFi ，或者刚插上网线时

本机由于没有 IP，也不知道 DHCP 服务器的地址是多少，所以根本不知道该向谁发起请求

于是索性选择广播，向本地网段内所有人发出消息，询问 **"谁能给个 IP 用用？"**

### 2、DHCP Offer

不是 DHCP 服务器的机器会忽略你的广播消息

而 DHCP 服务器收到消息后，会在自己维护的一个 IP 池里拿出一个空闲 IP，通过广播的形式给回你的电脑

在广播回复的可能使用点对点的单播，这要取决于终端设备支不支持单播。如果支持，终端在首次询问  **"谁能给个 IP 用用？"** 的广播中会携带支持的参数

### 3、DHCP Request

你的电脑在拿到 IP 后，再次发起广播，就说 "这个IP我要了"

### 4、DHCP ACK

DHCP 服务器此时再回复你一个 ACK，意思是 "ok的"。

你就正式获得这个 IP 在一段时间（比如24小时）里的使用权了

后续只要 IP 租约不过期，就可以一直用这个 IP 进行通信了。

这也是为什么你第二天到公司，重新开机后电脑还是昨天的 IP 的原因

## NAT / NAPT

我们家里的局域网内，基本上都用 192.168.xx.xx 这样的私有 IP。

这是因为 IPV4 地址一共分为 4 个字节，一个字节 8 位，共 32 位，能用来表示最多 2 ^32，也就是 42 亿个地址

而全球总人口都突破 80 亿了，也就是说人均一个 IP 都分不到

为了解决 IP 不够用的问题，网络被分为局域网和广域网，将 IP 分为了 "**私有 IP**" 和 "**公网 IP**"

一个局域网里的 N 多台机器都可以共用一个 广域网IP，小区里几幢楼可以共用一个 公网IP，大大增加了 "**可用 IP 数量**"

IP 地址不够用的问题解决了，但一个新的问题也产生了：

**服务器在回数据包的时候该怎么回？毕竟千家万户人用的都是 192.168.0.1，网络怎么知道该发给谁？**

DNS（Domain Name System，域名系统）

保存着某个域名对应的所有 ip 地址，一个会自动更新电话号码的通信录系统

```
OSI 七层模型有点复杂，只需要了解 Linux 的四层结构即可
// 具体协议有 HTTP、DNS、FTP 等
应用层：消息

// 具体协议有 TCP、UDP 等
传输层：消息 + tcp 头部

// 网络包的封装、分片、路由、转发，比如 IP、ICMP 等
网络层：消息 + tcp 头部 + ip 头部

// 网络包的封帧、 MAC 寻址、差错检测等
网络接口层：消息 + tcp 头部 + ip 头部 + mac 地址
```

数据从应用层开始，向下层层封装，总的来说：

- 传输层，给应用数据前面增加了 TCP 头；
- 网络层，给 TCP 数据包前面增加了 IP 头；
- 网络接口层，给 IP 数据包前后分别增加了帧头和帧尾；

## 参考资料

- [一次完整的HTTP请求过程](https://zhuanlan.zhihu.com/p/38240894)
- [图解网络基础专栏](https://juejin.cn/column/7140149312167608333)
- [揭秘 Linux 处理数据包完整流程](https://juejin.cn/post/7157188308219478023)
