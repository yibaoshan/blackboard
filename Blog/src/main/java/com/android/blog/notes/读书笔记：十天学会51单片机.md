
"好记性不如烂笔头"，读书笔记系列是为了记录自己的读书心得，文章内容一部分是摘抄原文，一部分是自己的理解和总结

本篇文章记录的是，来自郭天祥老师的《十天学会51单片机》视频课

### 一、写在前面

前段时间我在网上买了块 51 单片机开发板

接下来的两周，我每天下班回到家的第一件事就是，跟着郭天祥老师的《十天学会51单片机》视频鼓捣一会儿，那阵子在我们家天天都能听到蜂鸣器滴滴滴~滴滴滴的声音

我当时买开发版的初衷是想了解：单片机是如何执行代码的？

但是，直到我能控制8位数码管显示数字以后，我才意识到，哦~ 原来这是偏实践类的课程，理论知识讲的比较少，这和我原定的目标相差甚远。

于是，后续课程的串口、液晶屏啥的我就没有继续学了，在网上查了单片机原理作为本节课的补充。

本篇文章共包含两部分内容：

- 一是课程简介，介绍郭天祥老师的《十天学会51单片机》每小讲的课程内容
- 二是课程总结，主要是想聊聊我个人非常疑惑的一个问题，单片机是如何执行代码的？

接下来，我们先跟随郭天祥老师的脚步，一起来学习怎么控制单片机

### 二、十天学会51单片机

郭天祥老师的《十天学会51单片机》课程一共有13讲，每一讲的内容都是基于配套的 tx-1c 开发板展开

因此，在介绍课程内容之前，我们有必要先来了解  tx-1c 开发板的构成

如图，介绍各个元器件

 tx-1c 开发板上的每一个元器件的功能、原理课程内容都有介绍，开发版的学习要点如下：

- 最小系统必要条件：电源、晶振、复位电路
- 控制任意I/O口：输出控制电平高低、输入检测电平高低
- 掌握定时器的用法
- 掌握外部中断、定时器中断、串口中断
- 串口通信：单片机与单片机、单片机与计算机通信

课程内容大致是这些，从目录来看还是比较简单的。当我们具备控制这些简单设备的能力以后，其他复杂的功能原理上也都差不多

#### 点亮一个发光管

课程第一讲的内容是，老师的个人介绍，单片机的发展史，以及介绍单片机能做什么？

在课程结尾，老师带领我们点亮了一个发光二极管

由于点亮代码过于简单，我顺手把剩下的7个发光管一起点亮了，还另外制作了一个流水灯的程序送给老师，代码如下：

``` c
#include <reg52.h>

sbit led1 = P1^0;
...// 中间还有 6 个灯，忽略重复代码
sbit led8 = P1^7;

unsigned int index = 0; //轮到第几个 LED 灯
unsigned int toggle = 1; // 1 表示开灯 0 表示关灯 

void main(){
	while(1){
		perform_once();// 控制发光二极管亮灭
		delay();// 休眠一段时间，代码实现省略
	}
}

void perform_once(){
	if(index>=8){ // 让每个发光二极管，一轮亮，一轮灭
		index = 0;
		toggle = toggle == 1 ? 0 : 1;
	}

	switch(index){
		case 0:led1 = toggle;
		...
		case 8:led8 = toggle;
	}
	index++; // 控制下一个发光二极管
}

```

编写完上述代码以后，我们在 Kiel 中将 c 文件编译打包成 .hex 文件

再通过 STC_ISP 软件烧录到开发板中，将板子重新上电就可以看到代码运行效果了

我是效果图

#### 控制蜂鸣器发声

第二讲我们将要学习控制蜂鸣器发声，不过，在学习蜂鸣器之前，老师先接着上节课的内容，带我们一起实现了发光二极管的流水灯效果

唉嘿，流水灯效果我在上节课就搞定了，我可真是个懂得未雨绸缪挖地道的好孩子，骄傲.jpg

讲完流水灯的实现，老师接着教了我们怎么去控制蜂鸣器，再往后就是蜂鸣器发声实战了，代码也很简单

``` c
#include <reg52.h>

sbit beep = P2^3; //蜂鸣器

void main(){
	while(1){
		perform_once();// 让蜂鸣器配合发光二极管，滴滴滴~
		delay();// 休眠一段时间
	}
}

void perform_once(){
	if(index>=8){ 
		index = 0;
		toggle = toggle == 1 ? 0 : 1;
	}
	
	beep = toggle;

}
```

这里是直接在原先控制 LED 的基础上，增加了控制蜂鸣器的逻辑。让蜂鸣器当背景音乐，配合发光二极管流水灯一起发声

编写完上述代码以后，我们在 Kiel 中将 c 文件编译打包成 .hex 文件

再通过 STC_ISP 软件烧录到开发板中，将板子重新上电就可以看到代码运行效果了

我是效果图

#### 数码管显示、中断原理和定时器的应用

第三讲的内容比较多，有中断、定时器的原理，还有数码管的控制显示，其中数码管的段选和位选让我反应了好一会才理解

接下来又是动手实践

我在控制二极管、蜂鸣器的代码基础上加了数码管的显示逻辑，另外还单独写了一个检测外部中断的程序，这两段代码都比较长我就不放出来了，直接来看效果

我是图片  

学完定时器以后，老师在后面的4 ~ 13讲还介绍了：独立键盘、矩阵键盘的控制，串口通信，1602液晶屏显示，I2C总线等等

这几节课的视频我全部开2倍速看完的，视频中的代码我也没有动手实践

没有写代码是因为，前面几节课程我已经学会了：

1. 如何控制输出电平进而控制发光二极管、蜂鸣器
2. 如何检测输入电平
3. 如何使用中断、定时器

虽然东西不多，但学习目的已经达到了，再学会控制后面的几个元器件，对我来说意义不是很大

对剩下课程感兴趣的朋友，可以查看参考资料一栏中 “十天学会51单片机教程”

好了，课程简介部分到这里就先结束了

接下来的时间，我们来聊聊本篇文章中，我最感兴趣的话题：单片机是如何执行代码的？

*ps：就是为了这点醋才包的这顿饺子*

### 三、单片机是如何执行代码的？

在前面的课程实践过程中，不知道大家有没有发现

我们每次写完代码，都需要先用 Kiel 软件，将 c 文件编译成 .hex 文件

再通过 STC_ISP 软件烧录到开发板中，然后板子重新上电，我们就能看到新代码运行的效果了

Kiel 和 STC_ISP 这两个软件做了什么？为什么简单操作几步就可以让单片机运行我们的新代码？单片机是怎么运行的？

我们把前后流程捋一下，可以发现上述的操作流程，大致可以分为：编码、编译、烧录、单片机运行这四个阶段

想要了解单片机是怎么运行的，我们就需要知道，这几个阶段各自都做了哪些事情？

我们先来看第一步，编码阶段

#### 编码阶段

编码阶段就是把我们人类的想法，转换为编程语言来实现

比如我想让板子上的第一个发光二极管亮起来，用中文可以这样说：

板子啊，让你的第一个发光二极管亮起来好不好呀？

用代码的话可以这样写：

``` c
#include <reg52.h>

sbit led1 = P1^0;

void main(){
    led1 = 0;
}

```

核心代码就一句话：'led1 = 0' ，非常的简单

这里简单聊一下什么是编程语言，编程语言多种多样，有 C 、C++ 、Java、Python 等等

它们都是人类创造出来的不同规则的语言，最终都是要在下一阶段编译成汇编指令

我们用的是51单片机开发板，编程语言只能用51单片机系列的 C51

C51 除了库函数、数据类型、输入输出等几个方面和标准 C 语言有些许的区别，其他的写起来都差不多

并且，由于51单片机由于性能过于孱弱，没有跑操作系统的意义。所以，我们在编写代码时也不需要考虑多进程、多线程的概念，代码写起来也省心了许多

#### 编译阶段

我们的需求（点亮第一个二极管）用编程语言实现了以后，接下来就是要把这段逻辑代码，翻译给单片机去执行

怎么翻译呢？

这是编译器负责的事情，大致流程是，先把源代码进行语法解析，然后再转化为各个平台的机器代码

具体到51单片机，Kiel 集成了编译器的功能，我们写完代码后，将工程的目标指令集设置为 MCS-51，然后就可以一键打包成 .hex 可执行文件，等待下一阶段烧录到单片机

这里有两个比较关键的点，一是什么是指令集；二是什么是 hex 文件

我们先来看第一点，什么是指令集？

##### 1、什么是指令集

我们都知道，芯片是由无数个功能不同的电路组合而来，而电路又只能通过开关来控制

那么，芯片厂商就需要告诉其他人，应该通过什么样的规则，才来控制这个芯片上不同的电路

控制芯片的规则，就被称为指令集。

比如，51单片机使用的是 MCS-51 指令集，这个指令集包含了：数据传送、位操作、逻辑运算及转移、算术运算、控制转移5个大类，共计111条指令

每条指令都是 01010101 这样的 01 组合，一条指令有多少位0和1，要看具体用什么指令

在51单片机的111条指令中，1字节指令共有49条，2字节指令共有45条，3字节指令共有17条

##### 2、什么是 hex 文件

至于 Kiel 打包生成的 .hex 文件，我们可以用文本编辑器打开看看

我是图片

图片来源：课程视频截图

其实 hex 文件已经是编译过后得到的二进制组合了，里面的内容就是我们用 C51 写的业务代码，不过是被转换为一行行0和1，我们看不懂罢了

至于为什么显示的是十六进制，这是因为文本编辑器是以四个二进制当作一个单位读的，烧录到单片机还是以二进制来执行的

#### 烧录阶段

在上一步的编译阶段，所有需要执行的指令都已经准备好，保存在 .hex 文件中

接下来，我们只需要使用 STC-ISP 软件，把这些二进制数据，传输给单片机的存储单元（EEPROM）就完事了

烧录的过程和原理我也不清楚，也懒得去研究，感兴趣的朋友可以查看参考资料列出的，[STC 51单片机烧录协议分析](https://www.cnblogs.com/759222924lele/p/7222916.html) 和 [单片机为什么能直接烧录程序？](https://www.zhihu.com/question/322309698)这两篇文章

#### 运行阶段

好了，经过前面几个步骤后，现在单片机的 ROM 里面存储的是无数个高低电平，为了方便理解，我们把低电平用 0 来表示，高电平用 1 代表

接下来，按下开发板的电源键，在板子上电的一瞬间，

这些个高低电平就是控制一个个电路开和关，产生结果，或者执行

振荡器的时钟脉冲有多快，程序执行的速度就有多快

#### 小结

单片机的开发/运行流程大致是这样的，当然中间还有非常多的细节，总结一下单片机的运行流程：

1. 编码阶段，将业务逻辑解释成代码实现
2. 编译阶段，将代码解释成目标平台的机器语言，也就是 01 组合
3. 烧录阶段，把编译结果的 01 组合，传输到机器的存储单元，每个01都被存储为高低电平。此阶段是'虚拟世界'转向'物理世界'的转折点
4. 运行阶段，接下来的事情全部发生在物理电路层面上。在振荡器电路的驱动下，芯片开始取指、译指、执行，根据执行结果，或修改寄存器改变时序电路逻辑，或刷新主存等其他操作，然后继续取指、译指、执行，无限循环，直到断电

好，单片机是如何执行代码的？这个问题每个人，每一步展开都是一个大工程

到这里，一个缩略版的单片机运行流程就出来了，我们来总结

了解单片机的执行过程，对下一阶段（操作系统）的学习有很大的帮助。操作系统最重要的任务之一，就是管理 CPU 执行多任务

因为从单片机的角度来看，操作系统就是一个很大的应用程序

每次时钟脉冲到来，指令加载的传输电路，立刻将，因为寄存器的存在，相当于帮助我们按下了不同的开关组合，这些组合会得到一个结果，而这个结果或者影响其他寄存器的值，或者被传输到主存当中

接着，一直在 '取指执行'，如果我们没有写 while() 循环，编译器

### 四、结语

最后，我们来总结一下本文内容

对于课程简介，

对于我不熟悉的领域，我的期望是讲的越简单，越入门越好，这一点《十天学会51单片机》符合

优点是简单易懂，只需要有一点点语言基础，会不会 C/C++，对于我不熟悉的东西，我都习惯把自己当”傻瓜“，讲的越简单，越入门越好

总的来说，郭天祥老师的《十天学会51单片机》课程，适合已经有理论基础的科班出身学生学习，因为它更像是培训机构快速上手的实践课，

课程总结，不过也不能说是缺点，这不是课程的问题，是我的问题

如果像我一样，妄想通过这节课学习，可以放弃了

最后，我个人没有嵌入式开发经验，因此，如果本文写的不对的地方，还请各位大佬指出，我会第一时间改正，感谢。

全文完

### 五、参考资料

- [十天学会51单片机视频（郭天祥高清完整版）- 小破站](https://www.bilibili.com/video/BV1Yk4y1m7my/)
- [MCS-51 汇编语言指令集](http://www.ecengine.com/download/MCS-51%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80%E6%8C%87%E4%BB%A4%E9%9B%86.pdf)
- [51单片机（一）单片机发展概述 - 果果小师弟](https://blog.csdn.net/qq_39400113/article/details/105585924)
- [51单片机（二）单片机结构和原理 - 果果小师弟](https://blog.csdn.net/qq_39400113/article/details/105587900)
- [51单片机（三）80C51的指令系统 - 果果小师弟](https://blog.csdn.net/qq_39400113/article/details/105609750)
- [51单片机（四）80C51的程序设计 - 果果小师弟](https://blog.csdn.net/qq_39400113/article/details/105645043)
- [单片机为什么能直接烧录程序？- 知乎](https://www.zhihu.com/question/322309698)
- [既生Bin 何生Hex ？- 光豆儿](https://www.toutiao.com/article/6389936124517138690/)
- [STC 51单片机烧录协议分析 - 电型金刚](https://www.cnblogs.com/759222924lele/p/7222916.html)
- [基于51单片机的多线程操作系统设计 - 卖水果的](https://blog.csdn.net/qq_16038625/article/details/117196792)